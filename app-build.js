let scene,camera,renderer,controls,letterGroup,frontPage,backPage,autoRotate=!1,mouseX=0,mouseY=0,isMouseDown=!1,mouseXOnMouseDown=0,mouseYOnMouseDown=0,targetRotationX=0,targetRotationY=0,targetRotationOnMouseDownX=0,targetRotationOnMouseDownY=0;function isMobileDevice(){return window.innerWidth<=768}let lastTouchDistance=0,initialZoom=isMobileDevice()?8:7,targetZoom=initialZoom,isPinching=!1,lastTouchCenter={x:0,y:0};const themeColor="#923840",textColor="#111111";let mightyThreeFont=null;function init(){scene=new THREE.Scene,camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),camera.position.set(0,0,initialZoom),renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),renderer.setSize(window.innerWidth,window.innerHeight),renderer.shadowMap.enabled=!0,renderer.shadowMap.type=THREE.PCFSoftShadowMap,document.getElementById("canvas-container").appendChild(renderer.domElement),setupLighting(),createInvitationLetter(),setupEventListeners()}function setupLighting(){const e=new THREE.AmbientLight(16777215,.6);scene.add(e);const t=new THREE.DirectionalLight(16777215,.8);t.position.set(5,10,5),t.castShadow=!0,t.shadow.camera.near=.1,t.shadow.camera.far=50,t.shadow.camera.left=-10,t.shadow.camera.right=10,t.shadow.camera.top=10,t.shadow.camera.bottom=-10,scene.add(t);const o=new THREE.DirectionalLight(16777215,.4);o.position.set(-5,5,-5),scene.add(o);const n=new THREE.DirectionalLight(16777215,.25);n.position.set(10,0,0),scene.add(n);const i=new THREE.DirectionalLight(16777215,.25);i.position.set(-10,0,0),scene.add(i);const a=new THREE.DirectionalLight(16777215,.15);a.position.set(0,15,0),scene.add(a);const l=new THREE.PointLight(16774645,.2);l.position.set(-3,3,2),scene.add(l);const r=new THREE.PointLight(15792383,.2);r.position.set(3,-2,3),scene.add(r)}function createTexturesWithImages(e){const t=createLetterTexture("back"),o=new THREE.CanvasTexture(t),n=createLetterTexture("front"),i=new THREE.CanvasTexture(n),a=new Image;a.src="assets/hoa1.png",a.onload=function(){const e=n.getContext("2d"),t=n.width/2;e.save(),e.translate(t,490),e.rotate(300*Math.PI/180),e.drawImage(a,-80,-80,160,160),e.restore(),i.needsUpdate=!0};const l=new Image;l.src="assets/QA.png",l.onload=function(){const e=t.getContext("2d"),n=t.width/2;e.drawImage(l,n-70,-10,140,140),o.needsUpdate=!0};const r=new Image;r.src="assets/item1.png",r.onload=function(){const e=t.getContext("2d"),n=t.width/2-100;e.drawImage(r,n-27.5,640,55,55),o.needsUpdate=!0};const s=new Image;s.src="assets/item3.png",s.onload=function(){const e=t.getContext("2d"),n=t.width/2+100;e.drawImage(s,n-27.5,640,55,55),o.needsUpdate=!0};const c=[new THREE.MeshLambertMaterial({color:16316922}),new THREE.MeshLambertMaterial({color:16316922}),new THREE.MeshLambertMaterial({color:16316922}),new THREE.MeshLambertMaterial({color:16316922}),new THREE.MeshLambertMaterial({map:i}),new THREE.MeshLambertMaterial({map:o})];frontPage=new THREE.Mesh(e,c),frontPage.castShadow=!0,frontPage.receiveShadow=!0,letterGroup.add(frontPage),addNames3D(),addBackVenue3D()}function createInvitationLetter(){letterGroup=new THREE.Group;createTexturesWithImages(new THREE.BoxGeometry(4,6,.05)),scene.add(letterGroup)}function createLetterTexture(e){const t=document.createElement("canvas");t.width=512,t.height=768;const o=t.getContext("2d");if("front"===e)o.fillStyle="#ffffff",o.fillRect(0,0,t.width,t.height),o.textAlign="center",o.strokeStyle=themeColor,o.lineWidth=10,o.strokeRect(0,0,t.width,t.height),o.fillStyle=textColor,o.font="bold 16px MightyWings",o.fillText("NHÀ GÁI",130,60),o.fillText("ÔNG NGUYỄN TRỌNG BẰNG",130,90),o.fillText("BÀ NGUYỄN THỊ HOA",130,120),o.fillText("HIỂN KHÁNH, NINH BÌNH",130,150),o.fillText("NHÀ TRAI",t.width-130,60),o.fillText("ÔNG HÀ VĂN LONG",t.width-130,90),o.fillText("BÀ DƯƠNG THỊ KHÁNH",t.width-130,120),o.fillText("KINH BẮC, BẮC NINH",t.width-130,150),o.strokeStyle=textColor,o.lineWidth=2,o.beginPath(),o.moveTo(100,175),o.lineTo(t.width-100,175),o.stroke(),o.fillStyle=textColor,o.font="bold 17px MightyWings",o.fillText("TRÂN TRỌNG BÁO TIN",t.width/2,215),o.fillText("LỄ THÀNH HÔN CỦA CON CHÚNG TÔI",t.width/2,245),o.fillStyle=themeColor,o.font="bold 50px BohemeFloral, serif",o.fillText("and",t.width/2,370),o.font="bold 40px MightyWings",o.fillStyle=textColor,o.font="bold 17px MightyWings",o.fillText("HÔN LỄ ĐƯỢC CỬ HÀNH TẠI TƯ GIA",t.width/2,570),o.font="bold 15px MightyWings",o.fillText("Xóm Nhì, xã Hiển Khánh, tỉnh Ninh Bình",t.width/2,600),o.font="bold 17px MightyWings",o.fillText("VÀO LÚC 6:00 - THỨ BẢY",t.width/2,630),o.fillText("NGÀY 01 THÁNG 11 NĂM 2025",t.width/2,660),o.font="bold 15px MightyWings",o.fillText("Tức ngày 12 tháng 09 năm Ất Tỵ",t.width/2,690);else{o.fillStyle="#ffffff",o.fillRect(0,0,t.width,t.height),o.textAlign="center",o.strokeStyle=themeColor,o.lineWidth=10,o.strokeRect(0,0,t.width,t.height),o.fillStyle=textColor,o.font="bold 16px MightyWings",o.fillText("THÁNG 11 - NĂM 2025",t.width/2,125),o.fillStyle=themeColor,o.fillRect(70,140,t.width-140,30);const e=(t.width-140)/7,n=160;o.fillStyle="#ffffff",o.font="15px MightyWings",o.textAlign="center";["T.2","T.3","T.4","T.5","T.6","T.7","CN"].forEach(((t,i)=>{const a=70+(i+.5)*e;o.fillText(t,a,n)})),o.fillStyle=textColor,o.font="bold 15px MightyWings",o.textAlign="center";let i=1;const a=n+30;for(let t=0;t<5;t++)for(let n=0;n<7;n++)if(i<=35){if(0===t&&n<5)continue;const l=70+(n+.5)*e,r=a+28*t;if(1===i){o.fillStyle=themeColor,o.beginPath();const e=27,t=e/95,n=1.1*t,a=l+5-e/2,s=r-5-e/2;o.moveTo(a+25*n,s+25*t),o.bezierCurveTo(a+25*n,s+25*t,a+20*n,s,a,s),o.bezierCurveTo(a-30*n,s,a-30*n,s+35*t,a-30*n,s+35*t),o.bezierCurveTo(a-30*n,s+55*t,a-10*n,s+77*t,a+25*n,s+95*t),o.bezierCurveTo(a+60*n,s+77*t,a+80*n,s+55*t,a+80*n,s+35*t),o.bezierCurveTo(a+80*n,s+35*t,a+80*n,s,a+50*n,s),o.bezierCurveTo(a+35*n,s,a+25*n,s+25*t,a+25*n,s+25*t),o.fill(),o.fillStyle="#ffffff",o.fillText(i.toString(),l,r)}else o.fillStyle=textColor,o.fillText(i.toString(),l,r);i++}o.fillStyle=textColor,o.font="bold 17px MightyWings",o.fillText("TRÂN TRỌNG KÍNH MỜI",t.width/2,345),o.strokeStyle=textColor,o.lineWidth=2,o.beginPath(),o.moveTo(70,370),o.lineTo(t.width-70,370),o.stroke(),o.font="bold 16px MightyWings",o.fillText("Đến dự buổi tiệc chung vui cùng gia đình chúng tôi tại",t.width/2,400),o.fillStyle=textColor,o.font="bold 16px MightyWings",o.fillText("Xóm Nhì, xã Hiển Khánh, tỉnh Ninh Bình",t.width/2,535),o.font="bold 18px MightyWings",o.fillText("VÀO LÚC 17 GIỜ 30 - NGÀY 31.10.2025",t.width/2,570),o.font="bold 15px MightyWings",o.fillText("Tức ngày 11 tháng 09 năm Ất Tỵ",t.width/2,590),o.font="italic 15px MightyWings",o.fillText("Trân trọng cảm ơn sự hiện diện của Quý Khách!",t.width/2,620),o.font="bold 15px MightyWings",o.fillText("Đón khách 17:30",t.width/2-100,720),o.fillText("Khai tiệc 17:30",t.width/2+100,720)}return t}function addNames3D(){if(!letterGroup)return;const e=(e,t,o,n)=>{const i=new THREE.TextGeometry(e,{font:mightyThreeFont,size:t,height:.03,curveSegments:8,bevelEnabled:!0,bevelThickness:.01,bevelSize:.004,bevelSegments:3});i.computeBoundingBox(),i.center();const a=new THREE.MeshPhongMaterial({color:themeColor}),l=new THREE.Mesh(i,a);return l.position.set((e=>4*(e/512-.5))(o),(e=>6*(.5-e/768))(n),.035),l.castShadow=!0,l.receiveShadow=!1,l},t=()=>{const t=e("NGUYỄN THỊ MỸ AN",.25,256,300),o=e("HÀ PHÚ QUÝ",.25,256,410);letterGroup.add(t),letterGroup.add(o)};if(mightyThreeFont)return t(),void addBackVenue3D();(new THREE.FontLoader).load("assets/MightyWings.json",(e=>{mightyThreeFont=e,t(),addBackVenue3D()}),void 0,(e=>{console.error("Failed to load MightyWings.json for 3D text. Please add it under assets/",e)}))}function addBackVenue3D(){if(!letterGroup||!mightyThreeFont)return;const e=new THREE.TextGeometry("TƯ GIA NHÀ GÁI",{font:mightyThreeFont,size:.25,height:.03,curveSegments:8,bevelEnabled:!0,bevelThickness:.01,bevelSize:.004,bevelSegments:3});e.computeBoundingBox(),e.center();const t=new THREE.MeshPhongMaterial({color:themeColor}),o=new THREE.Mesh(e,t);o.position.set(4*(256/512-.5),6*(.5-460/768),-.035),o.rotation.y=Math.PI,o.castShadow=!0,o.receiveShadow=!1,letterGroup.add(o)}function setupEventListeners(){renderer.domElement.addEventListener("mousedown",onMouseDown,!1),renderer.domElement.addEventListener("mousemove",onMouseMove,!1),renderer.domElement.addEventListener("mouseup",onMouseUp,!1),renderer.domElement.addEventListener("wheel",onMouseWheel,!1),renderer.domElement.addEventListener("touchstart",onTouchStart,!1),renderer.domElement.addEventListener("touchmove",onTouchMove,!1),renderer.domElement.addEventListener("touchend",onTouchEnd,!1),window.addEventListener("resize",onWindowResize,!1)}function onMouseDown(e){e.preventDefault(),isMouseDown=!0,mouseXOnMouseDown=e.clientX-window.innerWidth/2,mouseYOnMouseDown=e.clientY-window.innerHeight/2,targetRotationOnMouseDownX=targetRotationX,targetRotationOnMouseDownY=targetRotationY}function onMouseMove(e){mouseX=e.clientX-window.innerWidth/2,mouseY=e.clientY-window.innerHeight/2,isMouseDown&&(targetRotationY=targetRotationOnMouseDownY+.02*(mouseX-mouseXOnMouseDown),targetRotationX=targetRotationOnMouseDownX+.02*(mouseY-mouseYOnMouseDown))}function onMouseUp(e){isMouseDown=!1}function onMouseWheel(e){targetZoom+=.01*e.deltaY,targetZoom=Math.max(3,Math.min(15,targetZoom))}function getTouchDistance(e){if(e.length<2)return 0;const t=e[0].clientX-e[1].clientX,o=e[0].clientY-e[1].clientY;return Math.sqrt(t*t+o*o)}function getTouchCenter(e){return e.length<2?{x:0,y:0}:{x:(e[0].clientX+e[1].clientX)/2,y:(e[0].clientY+e[1].clientY)/2}}function onTouchStart(e){if(1===e.touches.length){const t=e.touches[0];onMouseDown({preventDefault:()=>{},clientX:t.clientX,clientY:t.clientY})}else 2===e.touches.length&&(isPinching=!0,lastTouchDistance=getTouchDistance(e.touches),lastTouchCenter=getTouchCenter(e.touches),e.preventDefault())}function onTouchMove(e){if(1!==e.touches.length||isPinching){if(2===e.touches.length&&isPinching){const t=getTouchDistance(e.touches);if(lastTouchDistance>0){const e=t/lastTouchDistance;targetZoom=Math.max(3,Math.min(15,targetZoom/e))}lastTouchDistance=t,e.preventDefault()}}else{const t=e.touches[0];onMouseMove({clientX:t.clientX,clientY:t.clientY})}}function onTouchEnd(e){e.touches.length<2&&(isPinching=!1,lastTouchDistance=0),0===e.touches.length&&onMouseUp(e)}function getOptimalPixelRatio(){const e=window.devicePixelRatio;if(isMobileDevice())return Math.min(e,1.2);const t=document.createElement("canvas"),o=t.getContext("2d");t.width=1e3,t.height=1e3;const n=performance.now();o.fillRect(0,0,1e3,1e3);return performance.now()-n>1?Math.min(e,1.2):Math.min(e,2)}function resizeRendererToDisplaySize(e){const t=e.domElement,o=getOptimalPixelRatio(),n=Math.floor(t.clientWidth*o),i=Math.floor(t.clientHeight*o),a=t.width!==n||t.height!==i;return a&&(e.setPixelRatio(o),e.setSize(n,i,!1)),a}function animate(){if(requestAnimationFrame(animate),resizeRendererToDisplaySize(renderer)){const e=renderer.domElement;camera.aspect=e.clientWidth/e.clientHeight,camera.updateProjectionMatrix()}letterGroup&&(letterGroup.rotation.y+=.05*(targetRotationY-letterGroup.rotation.y),letterGroup.rotation.x+=.05*(targetRotationX-letterGroup.rotation.x),autoRotate&&(targetRotationY+=.01)),camera.position.z+=.1*(targetZoom-camera.position.z),renderer.render(scene,camera)}function setView(e){targetRotationX=0,targetRotationY=0;const t=isMobileDevice()?8:7;switch(e){case"front":camera.position.set(0,0,t),targetZoom=t,targetRotationY=0;break;case"back":camera.position.set(0,0,t),targetZoom=t,targetRotationY=Math.PI;break;case"top":camera.position.set(0,10,2),targetZoom=2,targetRotationX=-Math.PI/3;break;case"perspective":camera.position.set(5,3,t),targetZoom=t,targetRotationY=Math.PI/6,targetRotationX=Math.PI/12}}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight);const e=isMobileDevice()?8:7;Math.abs(targetZoom-e)>1&&(targetZoom=e),updateEnvelopeImage()}const bohemeFont=new FontFace("BohemeFloral","url(assets/bohemefloral.woff)"),mightyFont=new FontFace("MightyWings","url(assets/MightyWings.otf)");Promise.all([bohemeFont.load().then((function(e){document.fonts.add(e)})),mightyFont.load().then((function(e){document.fonts.add(e)}))]).then((()=>{init(),animate(),updateRSVPButtonVisibility(),updateEnvelopeImage()})).catch((e=>{console.log("Font loading failed:",e),init(),animate(),updateRSVPButtonVisibility(),updateEnvelopeImage()}));const qrButton=document.getElementById("qrButton"),mapButton=document.getElementById("mapButton"),modalBackdrop=document.getElementById("modalBackdrop"),modalClose=document.getElementById("modalClose"),qrModalContent=document.getElementById("qrModalContent"),mapModalContent=document.getElementById("mapModalContent"),rsvpModalBackdrop=document.getElementById("rsvpModalBackdrop"),rsvpModalClose=document.getElementById("rsvpModalClose"),rsvpForm=document.getElementById("rsvpForm"),rsvpBtn=document.getElementById("rsvp-btn"),galleryModalBackdrop=document.getElementById("galleryModalBackdrop"),galleryModalClose=document.getElementById("galleryModalClose"),galleryBtn=document.getElementById("open-gallery-btn"),musicBtn=document.getElementById("music-btn"),musicIcon=document.getElementById("music-icon"),backgroundMusic=document.getElementById("backgroundMusic");let isMusicMuted=!1;function openModal(e){"qr"===e?(qrModalContent.style.display="block",mapModalContent.style.display="none"):"map"===e&&(mapModalContent.style.display="block",qrModalContent.style.display="none"),modalBackdrop.classList.add("active")}function closeModal(){modalBackdrop.classList.remove("active")}function openRSVPModal(){rsvpModalBackdrop.classList.add("active")}function closeRSVPModal(){rsvpModalBackdrop.classList.remove("active")}function hasSubmittedRSVP(){return"true"===localStorage.getItem("rsvpSubmitted")}function markRSVPSubmitted(){localStorage.setItem("rsvpSubmitted","true")}function scheduleRSVPModal(){hasSubmittedRSVP()||setTimeout((()=>{openRSVPModal()}),3e4)}function updateRSVPButtonVisibility(){hasSubmittedRSVP()?rsvpBtn.style.display="none":rsvpBtn.style.display="flex"}async function submitToGoogleSheets(e){try{await fetch("https://script.google.com/macros/s/AKfycbyV5CCMHp_YNRKvGKJaDKD6e-K7fv3KXeA_ZpTrR-okDbofFicaqEgbdBtGq5CeP09Q/exec",{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});return!0}catch(e){return console.error("Error submitting to Google Sheets:",e),!1}}function openGalleryModal(){galleryModalBackdrop.classList.add("active")}function closeGalleryModal(){galleryModalBackdrop.classList.remove("active")}function toggleMusic(){backgroundMusic&&(isMusicMuted?(backgroundMusic.volume=.5,isMusicMuted=!1,updateMusicIcon(!1)):(backgroundMusic.volume=0,isMusicMuted=!0,updateMusicIcon(!0)))}function updateMusicIcon(e){musicIcon&&(musicIcon.innerHTML=e?'\n      <path d="M9 18V5l12-2v13"/>\n      <circle cx="6" cy="18" r="3"/>\n      <circle cx="18" cy="16" r="3"/>\n      <path d="M2 2l20 20" stroke="currentColor" stroke-width="2"/>\n    ':'\n      <path d="M9 18V5l12-2v13"/>\n      <circle cx="6" cy="18" r="3"/>\n      <circle cx="18" cy="16" r="3"/>\n    ')}function updateEnvelopeImage(){const e=document.querySelector(".letter .text img");e&&(isMobileDevice()?e.src="assets/ACN03107.webp":e.src="assets/ACN02733.webp")}function openLetter(){updateEnvelopeImage(),backgroundMusic&&(backgroundMusic.volume=.5,backgroundMusic.loop=!0,backgroundMusic.play().catch((e=>{console.log("Autoplay prevented:",e)})));const e=document.querySelector(".evelope-container");e&&e.classList.add("disapear");const t=document.querySelector(".envelopeWrapper");t&&t.classList.add("flap");const o=document.querySelector(".envelopImg");o&&o.classList.add("envelopOpen");const n=document.querySelector(".letter");n&&n.classList.add("lineUptop");const i=document.querySelector(".envelopBodyImg");i&&i.classList.add("shadow");const a=document.querySelector(".hearts");a&&a.classList.remove("close");const l=document.querySelector(".loading-screen"),r=document.querySelector(".main-content");l&&(setTimeout((()=>{l.remove(),a.remove(),r&&(r.style.display="block",r.offsetHeight,r.classList.add("show"))}),6e3),scheduleRSVPModal())}qrButton.addEventListener("click",(()=>openModal("qr"))),mapButton.addEventListener("click",(()=>openModal("map"))),modalClose.addEventListener("click",closeModal),modalBackdrop.addEventListener("click",(e=>{e.target===modalBackdrop&&closeModal()})),rsvpForm.addEventListener("submit",(async e=>{e.preventDefault();const t=rsvpForm.querySelector(".submit-btn"),o=t.textContent;t.disabled=!0,t.textContent="Đang gửi...";const n={name:document.getElementById("guestName").value,attendance:document.querySelector('input[name="attendance"]:checked').value,wishes:document.getElementById("wishes").value||"",timestamp:(new Date).toISOString()};try{if(!await submitToGoogleSheets(n))throw new Error("Failed to submit");markRSVPSubmitted(),updateRSVPButtonVisibility(),closeRSVPModal()}catch(e){alert("Có lỗi xảy ra khi gửi phản hồi. Vui lòng thử lại sau."),console.error("Submission error:",e)}finally{t.disabled=!1,t.textContent=o}})),rsvpModalClose.addEventListener("click",closeRSVPModal),rsvpModalBackdrop.addEventListener("click",(e=>{e.target===rsvpModalBackdrop&&closeRSVPModal()})),rsvpBtn.addEventListener("click",openRSVPModal),galleryBtn.addEventListener("click",openGalleryModal),galleryModalClose.addEventListener("click",closeGalleryModal),galleryModalBackdrop.addEventListener("click",(e=>{e.target===galleryModalBackdrop&&closeGalleryModal()})),musicBtn.addEventListener("click",toggleMusic);
let e,t,n,o,i,a=0,s=0,c=!1,d=0,r=0,l=0,h=0,u=0,E=0;function m(){return window.innerWidth<=768}let w=0,T=m()?8:7,v=T,g=!1,p={x:0,y:0};let f=null,H=null;function y(){e=new THREE.Scene,t=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),t.position.set(0,0,T),n=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),n.setSize(window.innerWidth,window.innerHeight),n.shadowMap.enabled=!0,n.shadowMap.type=THREE.PCFSoftShadowMap,document.getElementById("canvas-container").appendChild(n.domElement),function(){const t=new THREE.AmbientLight(16777215,.6);e.add(t);const n=new THREE.DirectionalLight(16777215,.8);n.position.set(5,10,5),n.castShadow=!0,n.shadow.camera.near=.1,n.shadow.camera.far=50,n.shadow.camera.left=-10,n.shadow.camera.right=10,n.shadow.camera.top=10,n.shadow.camera.bottom=-10,e.add(n);const o=new THREE.DirectionalLight(16777215,.4);o.position.set(-5,5,-5),e.add(o);const i=new THREE.DirectionalLight(16777215,.25);i.position.set(10,0,0),e.add(i);const a=new THREE.DirectionalLight(16777215,.25);a.position.set(-10,0,0),e.add(a);const s=new THREE.DirectionalLight(16777215,.15);s.position.set(0,15,0),e.add(s);const c=new THREE.PointLight(16774645,.2);c.position.set(-3,3,2),e.add(c);const d=new THREE.PointLight(15792383,.2);d.position.set(3,-2,3),e.add(d)}(),function(){o=new THREE.Group;(function(e){const t=new THREE.MeshLambertMaterial({color:"#923840"});i=new THREE.Mesh(e,t),i.castShadow=!0,i.receiveShadow=!0,o.add(i);const n=function(e,t,n){const o=e/2,i=t/2,a=new THREE.Shape;a.moveTo(-o+n,-i),a.lineTo(o-n,-i),a.quadraticCurveTo(o,-i,o,-i+n),a.lineTo(o,i-n),a.quadraticCurveTo(o,i,o-n,i),a.lineTo(-o+n,i),a.quadraticCurveTo(-o,i,-o,i-n),a.lineTo(-o,-i+n),a.quadraticCurveTo(-o,-i,-o+n,-i);return new THREE.ShapeGeometry(a)}(3.92,5.92,.3),a=new THREE.MeshLambertMaterial({color:"#ffffff"}),s=new THREE.Mesh(n,a);s.position.z=.025+.005,s.castShadow=!1,s.receiveShadow=!0,o.add(s);const c=new THREE.Mesh(n,a);c.position.z=-.025-.005,c.rotation.y=Math.PI,c.castShadow=!1,c.receiveShadow=!0,o.add(c);const d=new THREE.MeshLambertMaterial({color:"#f8f8f8",transparent:!0,opacity:.3}),r=new THREE.Mesh(n,d);r.position.z=.025+.002,r.castShadow=!1,r.receiveShadow=!0,o.add(r);const l=new THREE.Mesh(n,d);l.position.z=-.025-.002,l.rotation.y=Math.PI,l.castShadow=!1,l.receiveShadow=!0,o.add(l),function(){if(!o)return;const e=e=>6*(.5-e/768),t=e=>4*(e/512-.5),n=-.035,i=(n,o,i,a,s,c=0)=>{const d=new THREE.TextGeometry(n,{font:f,size:o,height:.02,curveSegments:8,bevelEnabled:!0,bevelThickness:.005,bevelSize:.002,bevelSegments:2});d.computeBoundingBox(),d.center();const r=new THREE.MeshPhongMaterial({color:"#111111",shininess:30,specular:2236962}),l=new THREE.Mesh(d,r);return l.position.set(t(i),e(a),s),l.rotation.y=c,l.castShadow=!1,l.receiveShadow=!1,l},a=(n,o,i,a,s,c,d=0)=>{const r=(new THREE.TextureLoader).load(n),l=new THREE.PlaneGeometry(o/100,i/100),h=new THREE.MeshLambertMaterial({map:r,transparent:!0}),u=new THREE.Mesh(l,h);return u.position.set(t(a),e(s),c),u.rotation.y=d,u.castShadow=!1,u.receiveShadow=!1,u},s=(n,o,i)=>{const a=new THREE.Shape;a.moveTo(.05,.05).bezierCurveTo(.05,.05,.04,0,0,0).bezierCurveTo(-.06,0,-.06,.07,-.06,.07).bezierCurveTo(-.06,.11,-.02,.154,.05,.19).bezierCurveTo(.12,.154,.16,.11,.16,.07).bezierCurveTo(.16,.07,.16,0,.1,0).bezierCurveTo(.07,0,.05,.05,.05,.05);const s=new THREE.ExtrudeGeometry(a,{depth:.03,bevelEnabled:!0,bevelThickness:.005,bevelSize:.005,bevelOffset:0,bevelSegments:3}),c=new THREE.MeshLambertMaterial({color:"#923840",transparent:!0,opacity:.9}),d=new THREE.Mesh(s,c);return d.position.set(t(n),e(o),i),d.rotation.z=Math.PI,d.castShadow=!1,d.receiveShadow=!1,d},c=()=>{o.add(i("NHÀ GÁI",13/768*6,130,60,.035)),o.add(i("ÔNG NGUYỄN TRỌNG BẰNG",11/768*6,130,90,.035)),o.add(i("BÀ NGUYỄN THỊ HOA",11/768*6,130,120,.035)),o.add(i("HIỂN KHÁNH, NINH BÌNH",11/768*6,130,150,.035)),o.add(i("NHÀ TRAI",13/768*6,382,60,.035)),o.add(i("ÔNG HÀ VĂN LONG",11/768*6,382,90,.035)),o.add(i("BÀ DƯƠNG THỊ KHÁNH",11/768*6,382,120,.035)),o.add(i("KINH BẮC, BẮC NINH",11/768*6,382,150,.035));const c=(new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(-1.5,e(180),.035),new THREE.Vector3(1.5,e(180),.035)]),d=new THREE.LineBasicMaterial({color:"#111111",linewidth:2}),r=new THREE.Line(c,d);o.add(r),o.add(i("TRÂN TRỌNG BÁO TIN",13/768*6,256,215,.035)),o.add(i("LỄ THÀNH HÔN CỦA CON CHÚNG TÔI",13/768*6,256,245,.035)),o.add(((n,o,i,a,s,c=0)=>{const d=new THREE.TextGeometry(n,{font:H,size:o,height:.03,curveSegments:8,bevelEnabled:!0,bevelThickness:.01,bevelSize:.004,bevelSegments:2});d.computeBoundingBox(),d.center();const r=new THREE.MeshPhongMaterial({color:"#923840",shininess:30,specular:2236962}),l=new THREE.Mesh(d,r);return l.position.set(t(i),e(a),s),l.rotation.y=c,l.castShadow=!0,l.receiveShadow=!1,l})("and",.390625,256,350,.035)),function(){if(!o)return;const e=(e,t,n,o)=>{const i=new THREE.TextGeometry(e,{font:f,size:t,height:.03,curveSegments:8,bevelEnabled:!0,bevelThickness:.01,bevelSize:.004,bevelSegments:3});i.computeBoundingBox(),i.center();const a=new THREE.MeshPhongMaterial({color:"#923840"}),s=new THREE.Mesh(i,a);return s.position.set((e=>4*(e/512-.5))(n),(e=>6*(.5-e/768))(o),.035),s.castShadow=!0,s.receiveShadow=!1,s},t=()=>{const t=e("NGUYỄN THỊ MỸ AN",.25,256,300),n=e("HÀ PHÚ QUÝ",.25,256,410);o.add(t),o.add(n)};if(f)return t(),void M();(new THREE.FontLoader).load("assets/MightyWings.json",e=>{f=e,t(),M()},void 0,e=>{console.error("Failed to load MightyWings.json for 3D text. Please add it under assets/",e)})}(),o.add(i("HÔN LỄ ĐƯỢC CỬ HÀNH TẠI TƯ GIA",15/768*6,256,570,.035)),o.add(i("Xóm Nhì, xã Hiển Khánh, tỉnh Ninh Bình",13/768*6,256,600,.035)),o.add(i("VÀO LÚC 6:00 - THỨ BẢY",15/768*6,256,635,.035)),o.add(i("NGÀY 01 THÁNG 11 NĂM 2025",15/768*6,256,665,.035)),o.add(i("Tức ngày 12 tháng 09 năm Ất Tỵ",13/768*6,256,695,.035));const l=a("assets/hoa1.webp",150,150,256,490,.035);l.rotation.z=Math.PI/3,l.material.opacity=.7,l.material.transparent=!0,o.add(l);const h=(n,o,i,a,s,c=0)=>{const d=new THREE.TextGeometry(n,{font:f,size:o,height:.02,curveSegments:8,bevelEnabled:!0,bevelThickness:.005,bevelSize:.002,bevelSegments:2});d.computeBoundingBox(),d.center();const r=new THREE.MeshPhongMaterial({color:"#ffffff",shininess:30,specular:2236962}),l=new THREE.Mesh(d,r);return l.position.set(t(i),e(a),s),l.rotation.y=c,l.castShadow=!1,l.receiveShadow=!1,l};o.add(i("THÁNG 11 - NĂM 2025",13/768*6,256,105,n,Math.PI)),o.add(i("TRÂN TRỌNG KÍNH MỜI",13/768*6,256,330,n,Math.PI));const u=(new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(-1.5,e(355),n),new THREE.Vector3(1.5,e(355),n)]),E=new THREE.LineBasicMaterial({color:"#111111",linewidth:2}),m=new THREE.Line(u,E);o.add(m),o.add(i("Đến dự buổi tiệc chung vui cùng gia đình chúng tôi tại",11/768*6,256,380,n,Math.PI)),o.add(i("Xóm Nhì, xã Hiển Khánh, tỉnh Ninh Bình",11/768*6,256,505,n,Math.PI)),o.add(i("VÀO LÚC 17 GIỜ 30 - NGÀY 31.10.2025",13/768*6,256,540,n,Math.PI)),o.add(i("Tức ngày 11 tháng 09 năm Ất Tỵ",11/768*6,256,570,n,Math.PI)),o.add(i("Trân trọng cảm ơn sự hiện diện của Quý Khách!",11/768*6,256,610,n,Math.PI)),o.add(i("Đón khách 17:30",11/768*6,356,715,n,Math.PI)),o.add(i("Khai tiệc 17:30",11/768*6,156,715,n,Math.PI));const w=new THREE.BoxGeometry(3.2,.27,.01),T=new THREE.MeshLambertMaterial({color:"#923840"}),v=new THREE.Mesh(w,T);v.position.set(0,e(150),n+.005),v.rotation.y=Math.PI,o.add(v);["CN","T.7","T.6","T.5","T.4","T.3","T.2"].forEach((e,t)=>{const i=70+(t+.5)*(372/7);o.add(h(e,13/768*6,i,150,n-.01,Math.PI))});let g=1;for(let e=0;e<5;e++)for(let t=6;t>=0;t--)if(g<=35){if(0===e&&t>1)continue;const a=70+(t+.5)*(372/7),c=180+28*e;1===g?(o.add(h(g.toString(),11/768*6,a,c,n,Math.PI)),o.add(s(a+6,c-10,n+.005,Math.PI))):o.add(i(g.toString(),11/768*6,a,c,n,Math.PI)),g++}o.add(a("assets/QA.png",130,130,256,45,n,Math.PI)),o.add(a("assets/item3.png",45,45,156,665,n,Math.PI)),o.add(a("assets/item1.png",45,45,356,665,n,Math.PI)),M()};if(f&&H)return void c();const d=new THREE.FontLoader;let r=0;const l=()=>{r++,2===r&&c()};d.load("assets/MightyWings.json",e=>{f=e,l()},void 0,e=>{console.error("Failed to load MightyWings.json for 3D text:",e),l()}),d.load("assets/BohemeFloral.json",e=>{H=e,l()},void 0,e=>{console.error("Failed to load BohemeFloral.json for 3D text:",e),l()})}()})(function(e,t,n,o){const i=e/2,a=t/2,s=n/2,c=new THREE.Shape;c.moveTo(-i+o,-a),c.lineTo(i-o,-a),c.quadraticCurveTo(i,-a,i,-a+o),c.lineTo(i,a-o),c.quadraticCurveTo(i,a,i-o,a),c.lineTo(-i+o,a),c.quadraticCurveTo(-i,a,-i,a-o),c.lineTo(-i,-a+o),c.quadraticCurveTo(-i,-a,-i+o,-a);const d={depth:n,bevelEnabled:!1},r=new THREE.ExtrudeGeometry(c,d);return r.translate(0,0,-s),r}(4,6,.05,.3)),e.add(o)}(),n.domElement.addEventListener("mousedown",R,!1),n.domElement.addEventListener("mousemove",b,!1),n.domElement.addEventListener("mouseup",S,!1),n.domElement.addEventListener("wheel",L,!1),n.domElement.addEventListener("touchstart",B,!1),n.domElement.addEventListener("touchmove",N,!1),n.domElement.addEventListener("touchend",C,!1),window.addEventListener("resize",k,!1)}function M(){if(!o||!f)return;const e=new THREE.TextGeometry("TƯ GIA NHÀ GÁI",{font:f,size:.25,height:.03,curveSegments:8,bevelEnabled:!0,bevelThickness:.01,bevelSize:.004,bevelSegments:3});e.computeBoundingBox(),e.center();const t=new THREE.MeshPhongMaterial({color:"#923840"}),n=new THREE.Mesh(e,t);n.position.set(4*(256/512-.5),6*(.5-440/768),-.035),n.rotation.y=Math.PI,n.castShadow=!0,n.receiveShadow=!1,o.add(n)}function R(e){e.preventDefault(),c=!0,d=e.clientX-window.innerWidth/2,r=e.clientY-window.innerHeight/2,u=l,E=h}function b(e){a=e.clientX-window.innerWidth/2,s=e.clientY-window.innerHeight/2,c&&(h=E+.02*(a-d),l=u+.02*(s-r))}function S(e){c=!1}function L(e){v+=.01*e.deltaY,v=Math.max(3,Math.min(15,v))}function I(e){if(e.length<2)return 0;const t=e[0].clientX-e[1].clientX,n=e[0].clientY-e[1].clientY;return Math.sqrt(t*t+n*n)}function B(e){if(1===e.touches.length){const t=e.touches[0];R({preventDefault:()=>{},clientX:t.clientX,clientY:t.clientY})}else 2===e.touches.length&&(g=!0,w=I(e.touches),t=e.touches,p=t.length<2?{x:0,y:0}:{x:(t[0].clientX+t[1].clientX)/2,y:(t[0].clientY+t[1].clientY)/2},e.preventDefault());var t}function N(e){if(1!==e.touches.length||g){if(2===e.touches.length&&g){const t=I(e.touches);if(w>0){const e=t/w;v=Math.max(3,Math.min(15,v/e))}w=t,e.preventDefault()}}else{const t=e.touches[0];b({clientX:t.clientX,clientY:t.clientY})}}function C(e){e.touches.length<2&&(g=!1,w=0),0===e.touches.length&&S()}let P=null;function x(e){const t=e.domElement,n=function(){if(null!==P)return P;const e=window.devicePixelRatio;if(m())return P=Math.min(e,1.2),P;const t=document.createElement("canvas"),n=t.getContext("2d");t.width=1e3,t.height=1e3;const o=performance.now();n.fillRect(0,0,1e3,1e3);const i=performance.now();return P=i-o>1?Math.min(e,1.2):Math.min(e,2),P}(),o=Math.floor(t.clientWidth*n),i=Math.floor(t.clientHeight*n),a=t.width!==o||t.height!==i;return a&&(console.log("resize renderer to display size"),e.setPixelRatio(n),e.setSize(o,i,!1)),a}function G(){requestAnimationFrame(G),o&&(o.rotation.y+=.05*(h-o.rotation.y),o.rotation.x+=.05*(l-o.rotation.x)),t.position.z+=.1*(v-t.position.z),n.render(e,t)}function k(){t.aspect=window.innerWidth/window.innerHeight,t.updateProjectionMatrix(),n.setSize(window.innerWidth,window.innerHeight),x(n);const e=m()?8:7;Math.abs(v-e)>1&&(v=e)}const z=new FontFace("MightyWings","url(assets/MightyWings.otf)");Promise.all([z.load().then((function(e){document.fonts.add(e)}))]).then(()=>{y(),G(),ae()}).catch(e=>{console.log("Font loading failed:",e),y(),G(),ae()});const q=document.getElementById("qrButton"),D=document.getElementById("mapButton"),Y=document.getElementById("modalBackdrop"),F=document.getElementById("modalClose"),W=document.getElementById("qrModalContent"),K=document.getElementById("mapModalContent"),X=document.getElementById("rsvpModalBackdrop"),A=document.getElementById("rsvpModalClose"),O=document.getElementById("rsvpForm"),V=document.getElementById("rsvp-btn"),j=document.getElementById("galleryModalBackdrop"),U=document.getElementById("galleryModalClose"),Q=document.getElementById("open-gallery-btn"),J=document.getElementById("music-btn"),_=document.getElementById("music-icon"),Z=document.getElementById("backgroundMusic");let $=!1;function ee(e){"qr"===e?(W.style.display="block",K.style.display="none"):"map"===e&&(K.style.display="block",W.style.display="none"),Y.classList.add("active")}function te(){Y.classList.remove("active")}function ne(){X.classList.add("active")}function oe(){X.classList.remove("active")}function ie(){return"true"===localStorage.getItem("rsvpSubmitted")}function ae(){ie()?V.style.display="none":V.style.display="flex"}function se(){j.classList.remove("active")}function ce(e){_&&(_.innerHTML=e?'\n      <path d="M9 18V5l12-2v13"/>\n      <circle cx="6" cy="18" r="3"/>\n      <circle cx="18" cy="16" r="3"/>\n      <path d="M2 2l20 20" stroke="currentColor" stroke-width="2"/>\n    ':'\n      <path d="M9 18V5l12-2v13"/>\n      <circle cx="6" cy="18" r="3"/>\n      <circle cx="18" cy="16" r="3"/>\n    ')}q.addEventListener("click",()=>ee("qr")),D.addEventListener("click",()=>ee("map")),F.addEventListener("click",te),Y.addEventListener("click",e=>{e.target===Y&&te()}),O.addEventListener("submit",async e=>{e.preventDefault();const t=O.querySelector(".submit-btn"),n=t.textContent;t.disabled=!0,t.textContent="Đang gửi...";const o={name:document.getElementById("guestName").value,attendance:document.querySelector('input[name="attendance"]:checked').value,wishes:document.getElementById("wishes").value||"",timestamp:(new Date).toISOString()};try{if(!await async function(e){try{await fetch("https://script.google.com/macros/s/AKfycbyV5CCMHp_YNRKvGKJaDKD6e-K7fv3KXeA_ZpTrR-okDbofFicaqEgbdBtGq5CeP09Q/exec",{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});return!0}catch(e){return console.error("Error submitting to Google Sheets:",e),!1}}(o))throw new Error("Failed to submit");localStorage.setItem("rsvpSubmitted","true"),ae(),oe()}catch(e){alert("Có lỗi xảy ra khi gửi phản hồi. Vui lòng thử lại sau."),console.error("Submission error:",e)}finally{t.disabled=!1,t.textContent=n}}),A.addEventListener("click",oe),X.addEventListener("click",e=>{e.target===X&&oe()}),V.addEventListener("click",ne),Q.addEventListener("click",(function(){j.classList.add("active")})),U.addEventListener("click",se),j.addEventListener("click",e=>{e.target===j&&se()}),J.addEventListener("click",(function(){Z&&($?(Z.volume=.5,$=!1,ce(!1)):(Z.volume=0,$=!0,ce(!0)))}));document.getElementById("open-letter-btn").addEventListener("click",(function(){Z&&(Z.volume=.4,Z.loop=!0,Z.play().catch(e=>{console.log("Autoplay prevented:",e)}));const e=document.querySelector(".evelope-container");e&&e.classList.add("disapear");const t=document.querySelector(".envelopeWrapper");t&&t.classList.add("flap");const n=document.querySelector(".envelopImg");n&&n.classList.add("envelopOpen");const o=document.querySelector(".letter");o&&o.classList.add("lineUptop");const i=document.querySelector(".envelopBodyImg");i&&i.classList.add("shadow");const a=document.querySelector(".hearts");a&&a.classList.remove("close");const s=document.querySelector(".loading-screen"),c=document.querySelector(".main-content");s&&(setTimeout(()=>{s.remove(),a.remove(),c&&(c.style.display="block",c.offsetHeight,c.classList.add("show"))},6e3),ie()||setTimeout(()=>{ne()},3e4))}))